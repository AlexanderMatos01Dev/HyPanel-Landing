---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/sections/Navbar";
import Footer from "../../components/sections/Footer";
import ArticleHeader from "../../components/blog/ArticleHeader.astro";
import { ShareSidebar } from "../../components/blog/ShareSidebar";
import TableOfContents from "../../components/blog/TableOfContents";
import RelatedPosts from "../../components/blog/RelatedPosts.astro";
import PostNavigation from "../../components/blog/PostNavigation.astro";
import ReadingProgress from "../../components/blog/ReadingProgress.astro";
import { ArrowLeft } from "lucide-react";
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import type { BlogPostProps } from "../../types/blog";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const sortedPosts = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
  
  return sortedPosts.map((post, index) => ({
    params: { id: post.slug },
    props: { 
      post,
      prevPost: index + 1 < sortedPosts.length ? sortedPosts[index + 1] : null,
      nextPost: index > 0 ? sortedPosts[index - 1] : null,
    },
  }));
}

interface Props extends BlogPostProps {
  prevPost: CollectionEntry<"blog"> | null;
  nextPost: CollectionEntry<"blog"> | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);

const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

const allPosts = await getCollection("blog");
let relatedPosts: CollectionEntry<"blog">[] = [];

if (post.data.relatedPosts && post.data.relatedPosts.length > 0) {
  const relatedSlugs = post.data.relatedPosts;
  relatedPosts = relatedSlugs
    .map(slug => allPosts.find(p => p.slug === slug))
    .filter((p): p is CollectionEntry<"blog"> => p !== undefined)
    .slice(0, 3);
} else {
  relatedPosts = allPosts
    .filter(p => p.slug !== post.slug)
    .filter(p => p.data.category === post.data.category || p.data.featured)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    .slice(0, 3);
}
---

<Layout
  title={`${post.data.title} - HyPanel Blog`}
  description={post.data.excerpt}
>
  <div
    class="min-h-screen bg-[#0B0F19] text-[#E0E6ED] font-sans selection:bg-[#EDA333] selection:text-[#0B0F19] relative"
  >
    <ReadingProgress />

    <!-- Navbar -->
    <div class="relative z-50">
      <Navbar client:visible />
    </div>

    <!-- Background Elements -->
    <div class="fixed inset-0 pointer-events-none -z-10">
      <div
        class="absolute top-0 left-0 w-full h-[600px] bg-gradient-to-b from-[#151D2C] via-[#0B0F19] to-transparent"
      >
      </div>
      <div
        class="absolute inset-0 bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:40px_40px] opacity-20"
      >
      </div>
    </div>

    <main class="relative z-10 pt-24 pb-24">
      <!-- Back to Blog Link -->
      <div class="max-w-[1400px] mx-auto px-6 mb-8">
        <a 
          href="/blog" 
          class="inline-flex items-center gap-2 text-[#8B9BB4] hover:text-[#EDA333] transition-colors text-sm group"
        >
          <ArrowLeft size={16} className="group-hover:-translate-x-1 transition-transform" />
          <span>Back to all articles</span>
        </a>
      </div>

      <!-- Main Grid Layout -->
      <div
        class="max-w-[1400px] mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12"
      >
        <!-- Left Sidebar (Share) -->
        <div class="hidden lg:block lg:col-span-1 h-full">
          <ShareSidebar client:load title={post.data.title} />
        </div>

        <!-- Center Content -->
        <div class="lg:col-span-8">
          <ArticleHeader post={post} />

          <!-- Article Body -->
          <article id="article-content" class="prose prose-invert prose-lg max-w-none w-full">
            <Content />
          </article>
          
          <PostNavigation prevPost={prevPost} nextPost={nextPost} />
        </div>

        <!-- Right Sidebar (Author & TOC) -->
        <div class="lg:col-span-3 h-full">
            <!-- Author Card -->
            <div
              class="p-5 rounded-2xl bg-gradient-to-br from-[#151D2C]/60 to-[#0F1623]/60 border border-[#2A3B4C] backdrop-blur-sm mb-6"
            >
              <span
                class="text-[10px] font-bold text-[#8B9BB4] uppercase tracking-wider mb-4 block"
                >Written by</span
              >
              <div class="flex items-center gap-4">
                <div class="relative shrink-0">
                  <div
                    class="absolute inset-0 bg-gradient-to-br from-[#4DA6FF] to-[#EDA333] rounded-full blur-[3px] opacity-60"
                  >
                  </div>
                  <img
                    src={post.data.authorImage || "https://api.dicebear.com/7.x/avataaars/svg?seed=hypanel"}
                    alt={post.data.author || "HyPanel Team"}
                    class="relative w-12 h-12 rounded-full border-2 border-[#151D2C] object-cover"
                  />
                </div>
                <div>
                  <div class="text-white font-semibold text-sm">
                    {post.data.author || "HyPanel Team"}
                  </div>
                  <div class="text-[#EDA333] text-xs font-medium">
                    {post.data.authorRole || "The Team"}
                  </div>
                </div>
              </div>
            </div>

            <div class="sticky top-28 space-y-6">
              {tocHeadings.length > 0 && (
                <TableOfContents client:load headings={tocHeadings} />
              )}
            </div>
        </div>
      </div>

      <!-- Footer Grid -->
      <div class="max-w-[1400px] mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mt-16">
          <div class="hidden lg:block lg:col-span-1"></div>
          <div class="lg:col-span-8">
              <!-- Article Footer CTA -->
              <div class="p-8 rounded-2xl bg-gradient-to-br from-[#151D2C] to-[#0F1623] border border-[#2A3B4C] relative overflow-hidden">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(77,166,255,0.1),transparent_50%)]"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_left,rgba(237,163,51,0.1),transparent_50%)]"></div>
                <div class="relative z-10">
                  <h3 class="text-2xl font-bold text-white mb-3">Be part of the journey</h3>
                  <p class="text-[#8B9BB4] mb-6 max-w-lg">
                    Join our Discord community to discuss this article, share feedback, and shape the future of HyPanel.
                  </p>
                  <div class="flex flex-wrap gap-4">
                    <a 
                      href="https://discord.gg/TrcwkU8x" 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-[#5865F2] hover:bg-[#4752C4] text-white font-medium transition-colors"
                    >
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                      </svg>
                      Join Discord
                    </a>
                    <a 
                      href="/blog" 
                      class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-[#151D2C] hover:bg-[#1a2435] border border-[#2A3B4C] text-white font-medium transition-colors"
                    >
                      Read more articles
                    </a>
                  </div>
                </div>
              </div>

              <RelatedPosts relatedPosts={relatedPosts} />
          </div>
        </div>
      </div>
    </main>

    <Footer />
  </div>
</Layout>

<style is:global>
  /* Scrollbar hide utility */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Custom Typography Styles */
  .prose {
    max-width: none;
  }

  /* Headings with better spacing - closer to content */
  .prose h2 {
    font-size: 1.75rem;
    margin-top: 2.5rem;
    margin-bottom: 0.875rem;
    color: white;
    font-weight: 700;
    scroll-margin-top: 100px;
    position: relative;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(42, 59, 76, 0.4);
  }
  
  .prose h2::before {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 50px;
    height: 2px;
    background: linear-gradient(90deg, #EDA333, transparent);
  }

  .prose h3 {
    font-size: 1.25rem;
    margin-top: 1.75rem;
    margin-bottom: 0.625rem;
    color: #e0e6ed;
    font-weight: 600;
    scroll-margin-top: 100px;
  }

  .prose h4 {
    font-size: 1.0625rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: #d1d9e3;
    font-weight: 600;
    scroll-margin-top: 100px;
  }

  /* Paragraphs with better readability */
  .prose p {
    margin-bottom: 1.25rem;
    line-height: 1.75;
    color: #a1afc4;
    font-size: 1rem;
    max-width: 70ch; /* Optimal reading width */
  }

  /* First paragraph after heading - no extra space */
  .prose h2 + p,
  .prose h3 + p,
  .prose h4 + p {
    margin-top: 0;
  }

  /* Emphasis and strong */
  .prose strong {
    color: #e0e6ed;
    font-weight: 600;
  }

  .prose em {
    color: #b8c5d3;
    font-style: italic;
  }

  /* Links */
  .prose a {
    color: #eda333;
    text-decoration: none;
    background: linear-gradient(90deg, rgba(237, 163, 51, 0.1), transparent);
    padding: 0.1em 0.3em;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  .prose a:hover {
    background: rgba(237, 163, 51, 0.2);
    color: #f5b94d;
  }

  /* Lists with better styling */
  .prose ul,
  .prose ol {
    margin-bottom: 1.75rem;
    padding-left: 0;
    color: #94a3b8;
  }

  .prose ul {
    list-style: none;
  }

  .prose ul li {
    position: relative;
    padding-left: 1.75rem;
    margin-bottom: 0.75rem;
    line-height: 1.7;
  }

  .prose ul li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.6em;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: linear-gradient(135deg, #EDA333, #4DA6FF);
  }

  .prose ol {
    list-style: none;
    counter-reset: ol-counter;
  }

  .prose ol li {
    position: relative;
    padding-left: 2.5rem;
    margin-bottom: 0.75rem;
    counter-increment: ol-counter;
    line-height: 1.7;
  }

  .prose ol li::before {
    content: counter(ol-counter);
    position: absolute;
    left: 0;
    top: 0;
    width: 1.75rem;
    height: 1.75rem;
    background: linear-gradient(135deg, rgba(237, 163, 51, 0.2), rgba(77, 166, 255, 0.1));
    border: 1px solid rgba(237, 163, 51, 0.3);
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: #EDA333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Nested lists */
  .prose ul ul,
  .prose ol ol,
  .prose ul ol,
  .prose ol ul {
    margin-top: 0.75rem;
    margin-bottom: 0;
  }

  /* Task lists (checkboxes) */
  .prose ul:has(input[type="checkbox"]) {
    list-style: none;
    padding-left: 0;
  }

  .prose ul li:has(input[type="checkbox"]) {
    padding-left: 0;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .prose ul li:has(input[type="checkbox"])::before {
    display: none;
  }

  .prose input[type="checkbox"] {
    appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #2A3B4C;
    border-radius: 0.375rem;
    background: #0F1623;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 0.2rem;
    transition: all 0.2s;
  }

  .prose input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #4DA6FF, #EDA333);
    border-color: transparent;
  }

  .prose input[type="checkbox"]:checked::after {
    content: 'âœ“';
    display: block;
    text-align: center;
    color: white;
    font-size: 0.75rem;
    font-weight: bold;
    line-height: 1.1rem;
  }

  /* Code Blocks - Enhanced */
  .prose pre {
    background: linear-gradient(180deg, #0a0e17 0%, #0f1623 100%) !important;
    border: 1px solid #1e293b;
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
    position: relative;
  }

  .prose pre::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #4DA6FF, #EDA333, #4DA6FF);
    border-radius: 1rem 1rem 0 0;
  }

  .prose code {
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.9em;
  }
  
  .prose :not(pre) > code {
    background: rgba(237, 163, 51, 0.1);
    color: #eda333;
    padding: 0.2em 0.5em;
    border-radius: 0.375rem;
    font-size: 0.875em;
    border: 1px solid rgba(237, 163, 51, 0.2);
  }

  /* Blockquotes - Premium style */
  .prose blockquote {
    border-left: none;
    background: linear-gradient(135deg, rgba(77, 166, 255, 0.08), rgba(237, 163, 51, 0.05));
    padding: 1.5rem 2rem;
    border-radius: 1rem;
    font-style: normal;
    color: #d1d9e3;
    margin: 2rem 0;
    position: relative;
    border: 1px solid rgba(77, 166, 255, 0.15);
  }

  .prose blockquote::before {
    content: '"';
    position: absolute;
    top: -0.5rem;
    left: 1.5rem;
    font-size: 4rem;
    color: rgba(77, 166, 255, 0.3);
    font-family: Georgia, serif;
    line-height: 1;
  }

  .prose blockquote p {
    color: #d1d9e3;
    font-size: 1.0625rem;
    margin-bottom: 0;
    position: relative;
    z-index: 1;
  }

  .prose blockquote p:last-child {
    margin-bottom: 0;
  }

  /* Tables - Modern design */
  .prose table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 2rem 0;
    overflow: hidden;
    border-radius: 1rem;
    border: 1px solid #2A3B4C;
  }

  .prose thead {
    background: linear-gradient(180deg, #151D2C 0%, #0F1623 100%);
  }

  .prose th {
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 600;
    color: #EDA333;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #2A3B4C;
  }

  .prose td {
    padding: 1rem 1.25rem;
    color: #94a3b8;
    font-size: 0.9375rem;
    border-bottom: 1px solid rgba(42, 59, 76, 0.5);
  }

  .prose tbody tr {
    background: rgba(15, 22, 35, 0.5);
    transition: background 0.2s;
  }

  .prose tbody tr:hover {
    background: rgba(77, 166, 255, 0.05);
  }

  .prose tbody tr:last-child td {
    border-bottom: none;
  }

  /* Horizontal rules */
  .prose hr {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent, #2A3B4C, #EDA333, #2A3B4C, transparent);
    margin: 3rem 0;
  }

  /* Lead paragraph */
  .prose .lead {
    font-size: 1.25rem;
    line-height: 1.7;
    color: #d1d9e3;
    font-weight: 400;
    margin-bottom: 2.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(237, 163, 51, 0.05), transparent);
    border-left: 3px solid #EDA333;
    border-radius: 0 1rem 1rem 0;
  }

  /* Images */
  .prose img {
    border-radius: 1rem;
    border: 1px solid #2A3B4C;
    margin: 2rem auto;
  }

  /* TOC Active state */
  .toc-link.active {
    background: rgba(237, 163, 51, 0.1);
    border-color: rgba(237, 163, 51, 0.3);
    color: #EDA333 !important;
  }

  .toc-link.active .toc-dot {
    background: #EDA333;
  }

  /* Line clamp utility */
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Mobile TOC Active state */
  .mobile-toc-link.active {
    background: rgba(237, 163, 51, 0.15);
    border-color: rgba(237, 163, 51, 0.3);
    color: #EDA333 !important;
  }

  .mobile-toc-link.active .mobile-toc-dot {
    background: #EDA333;
  }

  /* Mobile TOC panel open state */
  #mobile-toc-panel.open {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
  }

  /* Mobile TOC toggle button when open */
  #mobile-toc-toggle.open #toc-icon-list {
    opacity: 0;
    transform: scale(0.75) rotate(90deg);
  }

  #mobile-toc-toggle.open #toc-icon-close {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
</style>

<style is:global>
  /* Force article content to fill the container */
  #article-content {
    max-width: 100% !important;
    width: 100%;
  }
  
  /* Ensure paragraphs and other elements fill the width */
  #article-content > * {
    max-width: 100% !important;
  }
  
  /* Specifically target paragraphs to ensure they don't have a constrained width */
  #article-content p {
    max-width: 100% !important;
  }
</style>
